!function(b){var a=function(d,c){this.options=c;this.$element=b(d);var e=this.$element.attr("id");this.$container=b("<div/>",{id:"ms-"+e,"class":"ms-container"});this.$selectableContainer=b("<div/>",{"class":"ms-selectable"});this.$selectionContainer=b("<div/>",{"class":"ms-selection"});this.$selectableUl=b("<ul/>",{"class":"ms-list",tabindex:"-1"});this.$selectionUl=b("<ul/>",{"class":"ms-list",tabindex:"-1"});this.scrollTo=0;this.sanitizeRegexp=new RegExp("\\W+","gi");this.elemsSelector="li:visible:not(.ms-optgroup-label,.ms-optgroup-container)"};a.prototype={constructor:a,init:function(){var j=this,e=this.$element;if(e.next(".ms-container").length===0){e.css({position:"absolute",left:"-9999px"});e.attr("id",e.attr("id")?e.attr("id"):"ms-"+Math.ceil(Math.random()*1000));var f=null,i=null,l=0,c='<li class="ms-optgroup-container"></li>',d='<ul class="ms-optgroup"></ul>',g='<li class="ms-optgroup-label"><span></span></li>';e.find("optgroup, option").each(function(){if(b(this).is("optgroup")){f="<span>"+b(this).attr("label")+"</span>";i="ms-"+e.attr("id")+"-optgroup-"+l;var n=b(this),r=b(c),u=b(c),p=b(g),x=b(g);if(j.options.selectableOptgroup){x.on("click",function(){var y=n.children(":not(:selected)").map(function(){return b(this).val()}).get();j.select(y)});p.on("click",function(){var y=n.children(":selected").map(function(){return b(this).val()}).get();j.deselect(y)})}x.html(f);r.attr("id",i+"-selectable").append(b(d).append(x));j.$selectableUl.append(r);p.html(f);u.attr("id",i+"-selection").append(b(d).append(p));j.$selectionUl.append(u);l++}else{var o="";for(var q=0;q<this.attributes.length;q++){var s=this.attributes[q];if(j.isDomNode(s.name)){o+=s.name+'="'+s.value+'" '}}var t=b("<li "+o+"><span>"+b(this).text()+"</span></li>"),m=t.clone();var w=b(this).val(),v=j.sanitize(w,j.sanitizeRegexp);t.data("ms-value",w).addClass("ms-elem-selectable").attr("id",v+"-selectable");m.data("ms-value",w).addClass("ms-elem-selection").attr("id",v+"-selection").hide();j.$selectionUl.find(".ms-optgroup-label").hide();if(b(this).prop("disabled")||e.prop("disabled")){if(this.selected){m.prop("disabled",true);m.addClass(j.options.disabledClass)}else{t.prop("disabled",true);t.addClass(j.options.disabledClass)}}if(i){j.$selectableUl.children("#"+i+"-selectable").find("ul").first().append(t);j.$selectionUl.children("#"+i+"-selection").find("ul").first().append(m)}else{j.$selectableUl.append(t);j.$selectionUl.append(m)}}});if(j.options.selectableHeader){j.$selectableContainer.append(j.options.selectableHeader)}j.$selectableContainer.append(j.$selectableUl);if(j.options.selectableFooter){j.$selectableContainer.append(j.options.selectableFooter)}if(j.options.selectionHeader){j.$selectionContainer.append(j.options.selectionHeader)}j.$selectionContainer.append(j.$selectionUl);if(j.options.selectionFooter){j.$selectionContainer.append(j.options.selectionFooter)}j.$container.append(j.$selectableContainer);j.$container.append(j.$selectionContainer);e.after(j.$container);j.activeMouse(j.$selectableUl);j.activeKeyboard(j.$selectableUl);var h=j.options.dblClick?"dblclick":"click";j.$selectableUl.on(h,".ms-elem-selectable",function(){j.select(b(this).data("ms-value"))});j.$selectionUl.on(h,".ms-elem-selection",function(){j.deselect(b(this).data("ms-value"))});j.activeMouse(j.$selectionUl);j.activeKeyboard(j.$selectionUl);e.on("focus",function(){j.$selectableUl.focus()})}var k=e.find("option:selected").map(function(){return b(this).val()}).get();j.select(k,"init");if(typeof j.options.afterInit==="function"){j.options.afterInit.call(this,this.$container)}},activeKeyboard:function(c){var d=this;c.on("focus",function(){b(this).addClass("ms-focus")}).on("blur",function(){b(this).removeClass("ms-focus")}).on("keydown",function(f){switch(f.which){case 40:case 38:f.preventDefault();f.stopPropagation();d.moveHighlight(b(this),(f.which===38)?-1:1);return;case 32:f.preventDefault();f.stopPropagation();d.selectHighlighted(c);return;case 37:case 39:f.preventDefault();f.stopPropagation();d.switchList(c);return}})},moveHighlight:function(e,k){var c=e.find(this.elemsSelector),l=c.filter(".ms-hover"),n=null,d=c.first().outerHeight(),o=e.height(),g="#"+this.$container.prop("id");c.off("mouseenter");c.removeClass("ms-hover");if(k===1){n=l.nextAll(this.elemsSelector).first();if(n.length===0){var f=l.parent();if(f.hasClass("ms-optgroup")){var j=f.parent(),m=j.next(":visible");if(m.length>0){n=m.find(this.elemsSelector).first()}else{n=c.first()}}else{n=c.first()}}}else{if(k===-1){n=l.prevAll(this.elemsSelector).first();if(n.length===0){var f=l.parent();if(f.hasClass("ms-optgroup")){var j=f.parent(),i=j.prev(":visible");if(i.length>0){n=i.find(this.elemsSelector).last()}else{n=c.last()}}else{n=c.last()}}}}if(n.length>0){n.addClass("ms-hover");var h=e.scrollTop()+n.position().top-o/2+d/2;e.scrollTop(h)}},selectHighlighted:function(c){var e=c.find(this.elemsSelector),d=e.filter(".ms-hover").first();if(d.length>0){if(c.parent().hasClass("ms-selectable")){this.select(d.data("ms-value"))}else{this.deselect(d.data("ms-value"))}e.removeClass("ms-hover")}},switchList:function(c){c.blur();if(c.parent().hasClass("ms-selectable")){this.$selectionUl.focus()}else{this.$selectableUl.focus()}},activeMouse:function(c){var d=this;c.on("mousemove",function(){var e=c.find(d.elemsSelector);e.on("mouseenter",function(){e.removeClass("ms-hover");b(this).addClass("ms-hover")})})},refresh:function(){this.destroy();this.$element.multiSelect(this.options)},destroy:function(){b("#ms-"+this.$element.attr("id")).remove();this.$element.removeData("multiselect")},select:function(k,c){if(typeof k==="string"){k=[k]}var f=this,d=this.$element,g=b.map(k,function(m){return(f.sanitize(m,f.sanitizeRegexp))}),h=this.$selectableUl.find("#"+g.join("-selectable, #")+"-selectable").filter(":not(."+f.options.disabledClass+")"),e=this.$selectionUl.find("#"+g.join("-selection, #")+"-selection"),l=d.find("option").filter(function(){return(b.inArray(this.value,k)>-1)});if(h.length>0){h.addClass("ms-selected").hide();e.addClass("ms-selected").show();l.prop("selected",true);var j=f.$selectableUl.children(".ms-optgroup-container");if(j.length>0){j.each(function(){var m=b(this).find(".ms-elem-selectable");if(m.length===m.filter(".ms-selected").length){b(this).find(".ms-optgroup-label").hide()}});var i=f.$selectionUl.children(".ms-optgroup-container");i.each(function(){var m=b(this).find(".ms-elem-selection");if(m.filter(".ms-selected").length>0){b(this).find(".ms-optgroup-label").show()}})}if(c!=="init"){d.trigger("change");if(typeof f.options.afterSelect==="function"){f.options.afterSelect.call(this,k)}}}},deselect:function(j){if(typeof j==="string"){j=[j]}var e=this,c=this.$element,f=b.map(j,function(l){return(e.sanitize(l,e.sanitizeRegexp))}),g=this.$selectableUl.find("#"+f.join("-selectable, #")+"-selectable"),d=this.$selectionUl.find("#"+f.join("-selection, #")+"-selection").filter(".ms-selected"),k=c.find("option").filter(function(){return(b.inArray(this.value,j)>-1)});if(d.length>0){g.removeClass("ms-selected").show();d.removeClass("ms-selected").hide();k.prop("selected",false);var i=e.$selectableUl.children(".ms-optgroup-container");if(i.length>0){i.each(function(){var l=b(this).find(".ms-elem-selectable");if(l.filter(":not(.ms-selected)").length>0){b(this).find(".ms-optgroup-label").show()}});var h=e.$selectionUl.children(".ms-optgroup-container");h.each(function(){var l=b(this).find(".ms-elem-selection");if(l.filter(".ms-selected").length===0){b(this).find(".ms-optgroup-label").hide()}})}c.trigger("change");if(typeof e.options.afterDeselect==="function"){e.options.afterDeselect.call(this,j)}}},select_all:function(){var e=this.$element,d=e.val();e.find("option").prop("selected",true);this.$selectableUl.find(".ms-elem-selectable").addClass("ms-selected").hide();this.$selectionUl.find(".ms-optgroup-label").show();this.$selectableUl.find(".ms-optgroup-label").hide();this.$selectionUl.find(".ms-elem-selection").addClass("ms-selected").show();this.$selectionUl.focus();e.trigger("change");if(typeof this.options.afterSelect==="function"){var c=b.grep(e.val(),function(f){return b.inArray(f,d)<0});this.options.afterSelect.call(this,c)}},deselect_all:function(){var d=this.$element,c=d.val();d.find("option").prop("selected",false);this.$selectableUl.find(".ms-elem-selectable").removeClass("ms-selected").show();this.$selectionUl.find(".ms-optgroup-label").hide();this.$selectableUl.find(".ms-optgroup-label").show();this.$selectionUl.find(".ms-elem-selection").removeClass("ms-selected").hide();this.$selectableUl.focus();d.trigger("change");if(typeof this.options.afterDeselect==="function"){this.options.afterDeselect.call(this,c)}},isDomNode:function(c){return(c&&typeof c==="object"&&typeof c.nodeType==="number"&&typeof c.nodeName==="string")},sanitize:function(d,c){return(d.replace(c,"_"))}};b.fn.multiSelect=function(){var d=arguments[0],c=arguments;return this.each(function(){var g=b(this),f=g.data("multiselect"),e=b.extend({},b.fn.multiSelect.defaults,g.data(),typeof d==="object"&&d);if(!f){g.data("multiselect",(f=new a(this,e)))}if(typeof d==="string"){f[d](c[1])}else{f.init()}})};b.fn.multiSelect.defaults={selectableOptgroup:false,disabledClass:"disabled",dblClick:false};b.fn.multiSelect.Constructor=a}(window.jQuery);